from pathlib import Path

from openapi_client_generator.base_api_generator import BaseAPIGenerator


def _make_dummy(sub_overrides=None):
    """Helper to create a minimal concrete subclass with optional overrides."""

    class Dummy(BaseAPIGenerator):
        def _get_request_body_info(self, operation):
            return None

        def _get_response_model(self, operation):
            return None

        def _get_content_types(self, operation):
            return ([], [])

    if sub_overrides:
        for name, fn in sub_overrides.items():
            setattr(Dummy, name, fn)

    return Dummy


def test_call_abstract_methods_pass_lines():
    # Call the unbound abstract methods with a dummy self to execute the 'pass' lines
    BaseAPIGenerator._get_request_body_info(object(), {})
    BaseAPIGenerator._get_response_model(object(), {})
    BaseAPIGenerator._get_content_types(object(), {})


def test_generate_method_name_from_path_and_operation(tmp_path):
    Dummy = _make_dummy()
    paths = {"/a/b/{id}": {"get": {"parameters": [], "responses": {"200": {}}}}}
    gen = Dummy(paths, {}, "svc", tmp_path)
    ops = gen._extract_operations()
    content = gen._generate_apis_content("SvcAPIs", ops)
    assert "def get_a_b(" in content or "def get_a_b_" in content


def test_parameter_and_cookie_and_header_and_query_handling(tmp_path):
    def rb(self, operation):
        return {"type": "List[User]", "required": True, "is_json": True}

    def resp(self, operation):
        return "List[User]"

    def content_types(self, operation):
        return (["application/json"], ["application/json"])

    Dummy = _make_dummy({
        "_get_request_body_info": rb,
        "_get_response_model": resp,
        "_get_content_types": content_types,
    })

    paths = {
        "/v1/items/{itemId}": {
            "post": {
                "operationId": "createItem",
                "parameters": [
                    {"name": "itemId", "in": "path", "required": True, "schema": {"type": "string"}},
                    {"name": "q", "in": "query", "required": False, "schema": {"type": "string"}},
                    {"name": "X-API", "in": "header", "required": True, "schema": {"type": "string"}},
                    {"name": "sess", "in": "cookie", "required": False, "schema": {"type": "string"}},
                ],
                "responses": {"200": {"description": "OK"}},
            }
        }
    }

    gen = Dummy(paths, {"User": {}}, "svc", tmp_path)
    content = gen._generate_apis_content("SvcAPIs", gen._extract_operations())

    assert "def create_item(" in content
    assert "{item_id}" in content
    assert "params = {}" in content
    assert "headers = self.get_headers()" in content
    assert "cookies = {}" in content
    assert 'cookies["sid"]' or 'cookies["sess"]' in content
    assert "return [User.from_dict(item) for item in response.json()]" in content


def test_imports_and_model_handling(tmp_path):
    Dummy = _make_dummy()
    gen = Dummy({}, {"User": {}}, "svc", tmp_path)
    imports = gen._generate_imports()
    assert "from .models.User import User" in imports


def test_primitive_and_raw_responses(tmp_path):
    def resp_text(self, operation):
        return "str"

    def resp_none(self, operation):
        return None

    SubText = _make_dummy({"_get_response_model": resp_text})
    SubRaw = _make_dummy({"_get_response_model": resp_none})

    paths_text = {"/p": {"get": {"operationId": "ping", "parameters": [], "responses": {"200": {}}}}}

    gen_text = SubText(paths_text, {}, "svc", tmp_path)
    content_text = gen_text._generate_apis_content("SvcAPIs", gen_text._extract_operations())
    assert "return response.text" in content_text or "return response.json()" in content_text

    gen_raw = SubRaw(paths_text, {}, "svc", tmp_path)
    content_raw = gen_raw._generate_apis_content("SvcAPIs", gen_raw._extract_operations())
    assert "return self._make_request(" in content_raw
